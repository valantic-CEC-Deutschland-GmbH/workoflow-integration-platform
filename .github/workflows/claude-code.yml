name: Updater Agent

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  dependency-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Run dependency update agent
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        run: |
          claude -p "$(cat <<'PROMPT'
          You are a dependency update agent. Follow these steps exactly:

          ## Step 1: Check for existing PR
          Run: gh pr list --head ai/dependency-updates --state open --json number,title
          If an open PR exists, print "Open PR already exists, skipping." and stop here.

          ## Step 2: Create update branch
          Run: git checkout -B ai/dependency-updates origin/main

          ## Step 3: Discover outdated dependencies
          Run both commands and collect their output:
          - composer outdated --direct --format=json (if composer.json exists)
          - npm outdated --json (if package.json exists)
          If neither has updates available, print "All dependencies are up to date." and stop here.

          ## Step 4: Apply updates
          - If composer updates exist: run composer update
          - If npm updates exist: run npm update

          ## Step 5: Check for changes
          Run: git diff --stat
          If there are no changes, print "No file changes after update." and stop here.

          ## Step 6: Commit and push
          - Stage all changed files (composer.lock, package-lock.json, and any other modified files)
          - Create a commit with message: "chore: update dependencies"
          - Push: git push --force-with-lease origin ai/dependency-updates

          ## Step 7: Build PR description
          Create a detailed PR body that lists:
          - Each updated package with old version → new version
          - Group by composer and npm sections
          - For any MAJOR version bumps, use Context7 MCP tools (resolve-library-id then query-docs) to look up migration guides and note breaking changes

          ## Step 8: Create PR
          Run: gh pr create --base main --head ai/dependency-updates --title "chore: update dependencies" --body "<your PR body>"

          Important rules:
          - Do NOT run npm install or composer install from scratch — only update
          - Do NOT modify any source code, only dependency lock files
          - If a command fails, report the error clearly and stop
          PROMPT
          )" \
            --dangerously-skip-permissions \
            --output-format text \
            --verbose \
            --effort low \
            --model claude-sonnet-4-6 \
            --mcp-config .github/claude-mcp-config.json
