{% extends 'base.html.twig' %}

{% block title %}{{ 'general.title'|trans }} - Workoflow{% endblock %}

{% block body %}
<div class="dashboard-page">
    <div class="dashboard-container">

        {# Zone 1 - Agent Identity Header #}
        <div class="dashboard-hero">
            <div class="agent-avatar">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="10" rx="2"/>
                    <circle cx="8.5" cy="16" r="1.5"/>
                    <circle cx="15.5" cy="16" r="1.5"/>
                    <path d="M8 11V7a4 4 0 0 1 8 0v4"/>
                    <path d="M12 3v1"/>
                </svg>
            </div>
            <div class="dashboard-hero-text">
                <h1 class="dashboard-title">{{ 'general.welcome'|trans({'%name%': user.name}) }}</h1>
                {% if isOnboarding %}
                    <p class="dashboard-subtitle">{{ 'general.agent_ready_setup'|trans }}</p>
                {% else %}
                    <p class="dashboard-subtitle">{{ 'general.agent_ready'|trans({'%count%': integrations|length}) }}</p>
                {% endif %}
                {% if organisation %}
                    <p class="dashboard-tenant-name">{{ organisation.name }}</p>
                {% endif %}
            </div>
        </div>

        {# Zone 2 - Conditional content based on user state #}
        {% if isOnboarding %}
            {# State A: Onboarding card #}
            <div class="onboarding-card">
                <div class="onboarding-card-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--color-primary)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14l-5-4.87 6.91-1.01z"/>
                    </svg>
                </div>
                <h2 class="onboarding-card-title">{{ 'general.onboarding_title'|trans }}</h2>
                <p class="onboarding-card-description">{{ 'general.onboarding_description'|trans }}</p>
                <a href="{{ path('app_skills') }}" class="btn btn-primary btn-lg">
                    {{ 'general.add_first_skill'|trans }}
                </a>
            </div>
        {% else %}
            {# State B: Agent capabilities bar #}
            <div class="agent-capabilities">
                <span class="agent-capabilities-label">{{ 'general.agent_can_use'|trans }}</span>
                <div class="agent-capabilities-chips">
                    {% for skill in configuredSkills %}
                        <span class="skill-chip">
                            <img src="{{ asset(skill.logoPath) }}" alt="{{ skill.type }}" width="18" height="18">
                            {{ skill.type|upper }}
                        </span>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {# Zone 3 - Primary Action Card #}
        <div class="primary-action-card">
            <div class="primary-action-card-text">
                <h3>{{ 'general.manage_skills_title'|trans }}</h3>
                <p>{{ 'general.manage_skills_description'|trans }}</p>
            </div>
            <a href="{{ path('app_skills') }}" class="btn btn-primary">
                {{ 'general.manage_agent_skills'|trans }}
            </a>
        </div>

        {# Zone 4 - Recent Skills (only when 1+ skills) #}
        {% if not isOnboarding %}
            <div class="recent-skills-section">
                <div class="recent-skills-header">
                    <h3>{{ 'general.recent_skills'|trans }}</h3>
                    <a href="{{ path('app_skills') }}" class="view-all-link">{{ 'general.view_all'|trans }} &rarr;</a>
                </div>
                <div class="recent-skills-grid">
                    {% for integration in integrations|slice(0, 5) %}
                        <div class="recent-skill-card">
                            {% set skillType = integration.integrationType %}
                            {% set logoPath = configuredSkills[skillType] is defined ? configuredSkills[skillType].logoPath : '/images/logos/workoflow-logo.png' %}
                            <div class="recent-skill-card-header">
                                <img src="{{ asset(logoPath) }}" alt="{{ skillType }}" width="28" height="28" class="recent-skill-logo">
                                <span class="recent-skill-name">{{ integration.name }}</span>
                            </div>
                            <div class="recent-skill-card-footer">
                                {% if integration.active %}
                                    <span class="badge badge-active">{{ 'status.active'|trans }}</span>
                                {% else %}
                                    <span class="badge badge-inactive">{{ 'status.inactive'|trans }}</span>
                                {% endif %}
                                <a href="{{ path('app_tool_setup', {'type': skillType, 'instance': integration.id}) }}" class="btn btn-sm btn-secondary">
                                    {{ 'integration.edit'|trans }}
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {# Zone 5 - Technical Details (collapsed by default) #}
        {% if organisation %}
            <div class="technical-details-section">
                <button type="button" class="technical-details-toggle" id="techDetailsToggle">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="4 7 4 4 20 4 20 7"></polyline>
                        <line x1="9" y1="20" x2="15" y2="20"></line>
                        <line x1="12" y1="4" x2="12" y2="20"></line>
                    </svg>
                    {{ 'general.technical_details'|trans }}
                    <svg class="toggle-chevron" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                        <path d="M6 9L1 4h10L6 9z"/>
                    </svg>
                </button>
                <div class="technical-details-content" id="techDetailsContent" style="display: none;">
                    <div class="tech-detail-row">
                        <span class="tech-detail-label">{{ 'general.integration_api_url'|trans }}:</span>
                        <code>{{ organisation.integrationApiUrl }}</code>
                    </div>
                    {% if userOrganisation and userOrganisation.workflowUserId %}
                        <div class="tech-detail-row">
                            <span class="tech-detail-label">{{ 'general.workflow_user_id'|trans }}:</span>
                            <code>{{ userOrganisation.workflowUserId }}</code>
                        </div>
                        <div class="tech-detail-actions">
                            <button type="button" id="copyCurlBtn" class="btn btn-secondary btn-sm">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                {{ 'general.copy_curl_command'|trans }}
                            </button>
                            <span id="copiedMessage" class="copied-message" style="display: none;">{{ 'general.copied'|trans }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Technical details toggle
    var toggle = document.getElementById('techDetailsToggle');
    var content = document.getElementById('techDetailsContent');
    if (toggle && content) {
        toggle.addEventListener('click', function() {
            var isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            toggle.classList.toggle('is-open', isHidden);
        });
    }

    // Curl copy button
    var copyCurlBtn = document.getElementById('copyCurlBtn');
    var copiedMessage = document.getElementById('copiedMessage');
    if (copyCurlBtn) {
        copyCurlBtn.addEventListener('click', function() {
            var currentDomain = window.location.origin;
            var orgUuid = '{{ organisation.uuid }}';
            var workflowUserId = '{{ userOrganisation ? userOrganisation.workflowUserId : '' }}';
            var apiUrl = currentDomain + '/api/integrations/' + orgUuid + '?workflow_user_id=' + workflowUserId;
            var curlCommand = 'curl -X GET "' + apiUrl + '" \\\n  -H "Accept: application/json" \\\n  -H "Authorization: Basic YOUR_AUTH_TOKEN"';

            navigator.clipboard.writeText(curlCommand).then(function() {
                copiedMessage.style.display = 'inline';
                setTimeout(function() {
                    copiedMessage.style.display = 'none';
                }, 2000);
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
            });
        });
    }
});
</script>
{% endblock %}
